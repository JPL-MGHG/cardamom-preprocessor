<mxfile host="app.diagrams.net">
  <diagram name="ECMWF VPD Data Flow" id="ecmwf-vpd">
    <mxGraphModel dx="1434" dy="1100" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="1200">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <!-- CLI Entry Point -->
        <mxCell id="cli-entry" value="CLI Command&#xa;python -m src.stac_cli ecmwf&#xa;--variables vpd&#xa;--year 2020 --month 1&#xa;--output ./output" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="40" width="280" height="80" as="geometry"/>
        </mxCell>

        <!-- Variable Resolution -->
        <mxCell id="var-resolve" value="Variable Dependency Resolution&#xa;&#xa;Output var: vpd&#xa;→ Raw ERA5 vars: &#xa;   • 2m_temperature&#xa;   • 2m_dewpoint_temperature" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;align=left" vertex="1" parent="1">
          <mxGeometry x="40" y="160" width="280" height="100" as="geometry"/>
        </mxCell>

        <mxCell id="edge1" edge="1" parent="1" source="cli-entry" target="var-resolve">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- CDS API Call 1: Temperature -->
        <mxCell id="cds-api-temp" value="ECMWF CDS API Call #1: Temperature&#xa;cdsapi.Client.retrieve()&#xa;&#xa;Dataset: 'reanalysis-era5-single-levels-monthly-means'&#xa;Parameters:&#xa;  product_type: 'monthly_averaged_reanalysis_by_hour_of_day'&#xa;  variable: '2m_temperature'&#xa;  year: '2020'&#xa;  month: '01'&#xa;  time: ['00:00', '01:00', ..., '23:00']&#xa;  format: 'netcdf'" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left" vertex="1" parent="1">
          <mxGeometry x="40" y="300" width="380" height="160" as="geometry"/>
        </mxCell>

        <!-- CDS API Call 2: Dewpoint -->
        <mxCell id="cds-api-dew" value="ECMWF CDS API Call #2: Dewpoint&#xa;cdsapi.Client.retrieve()&#xa;&#xa;Dataset: 'reanalysis-era5-single-levels-monthly-means'&#xa;Parameters:&#xa;  product_type: 'monthly_averaged_reanalysis_by_hour_of_day'&#xa;  variable: '2m_dewpoint_temperature'&#xa;  year: '2020'&#xa;  month: '01'&#xa;  time: ['00:00', '01:00', ..., '23:00']&#xa;  format: 'netcdf'" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left" vertex="1" parent="1">
          <mxGeometry x="460" y="300" width="400" height="160" as="geometry"/>
        </mxCell>

        <mxCell id="edge2a" edge="1" parent="1" source="var-resolve" target="cds-api-temp">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="edge2b" edge="1" parent="1" source="var-resolve" target="cds-api-dew">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Raw NetCDF Files -->
        <mxCell id="raw-nc-temp" value="Raw Temperature NetCDF&#xa;File: raw/2m_temperature_2020_01.nc&#xa;&#xa;Dimensions: [24, 721, 1440]&#xa;Variable: 2m_temperature [K]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left" vertex="1" parent="1">
          <mxGeometry x="40" y="500" width="300" height="100" as="geometry"/>
        </mxCell>

        <mxCell id="raw-nc-dew" value="Raw Dewpoint NetCDF&#xa;File: raw/2m_dewpoint_temperature_2020_01.nc&#xa;&#xa;Dimensions: [24, 721, 1440]&#xa;Variable: 2m_dewpoint_temperature [K]" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left" vertex="1" parent="1">
          <mxGeometry x="380" y="500" width="340" height="100" as="geometry"/>
        </mxCell>

        <mxCell id="edge3a" edge="1" parent="1" source="cds-api-temp" target="raw-nc-temp">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="edge3b" edge="1" parent="1" source="cds-api-dew" target="raw-nc-dew">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Processing Step -->
        <mxCell id="process" value="Processing: Calculate VPD&#xa;_process_vpd()&#xa;&#xa;Operations:&#xa;  1. Extract monthly max temperature: max(temp, dim=time) → T_max_K&#xa;  2. Extract monthly max dewpoint: max(dewpoint, dim=time) → T_dew_K&#xa;  3. Convert to Celsius: T_max_C = T_max_K - 273.15&#xa;                        T_dew_C = T_dew_K - 273.15&#xa;  4. Calculate VPD using MATLAB-equivalent formula:&#xa;     calculate_vapor_pressure_deficit_matlab(T_max_C, T_max_C)&#xa;     Uses Tetens equation: e_sat = 6.1078 * exp(17.27*T/(T+237.3))&#xa;     VPD = e_sat(T_max) - e_sat(T_dewpoint)&#xa;&#xa;Input shapes: [24, 721, 1440] each&#xa;Output shape: [721, 1440]&#xa;Units: hPa (hectopascals)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left" vertex="1" parent="1">
          <mxGeometry x="760" y="500" width="380" height="280" as="geometry"/>
        </mxCell>

        <mxCell id="edge4a" edge="1" parent="1" source="raw-nc-temp" target="process">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="edge4b" edge="1" parent="1" source="raw-nc-dew" target="process">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Standard NetCDF Creation -->
        <mxCell id="standard-nc" value="Create Standard CARDAMOM NetCDF&#xa;create_standard_netcdf_dataset()&#xa;&#xa;Output Grid:&#xa;  Latitude: -89.75° to 89.75° (0.5° resolution) = 360 points&#xa;  Longitude: -179.75° to 179.75° (0.5° resolution) = 720 points&#xa;  Time: Single value (2020-01-01)&#xa;&#xa;Conventions: CF-1.8&#xa;Encoding: float32, zlib compression level 4" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left" vertex="1" parent="1">
          <mxGeometry x="380" y="820" width="420" height="160" as="geometry"/>
        </mxCell>

        <mxCell id="edge5" edge="1" parent="1" source="process" target="standard-nc">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Final Output -->
        <mxCell id="output" value="Output NetCDF File&#xa;File: output/data/vpd_2020_01.nc&#xa;&#xa;Dimensions:&#xa;  time: 1&#xa;  latitude: 360&#xa;  longitude: 720&#xa;&#xa;Variable: VPD [hPa]&#xa;Units: hPa (hectopascals)&#xa;Fill Value: -9999.0&#xa;Typical Range: 0-60 hPa&#xa;&#xa;Attributes:&#xa;  Conventions: 'CF-1.8'&#xa;  source: 'ECMWFDownloader'&#xa;  history: 'Created by CARDAMOM preprocessor'" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="820" width="300" height="240" as="geometry"/>
        </mxCell>

        <mxCell id="edge6" edge="1" parent="1" source="standard-nc" target="output">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Raw File Cleanup -->
        <mxCell id="cleanup" value="Cleanup (if --keep-raw not set)&#xa;Delete:&#xa;  • raw/2m_temperature_2020_01.nc&#xa;  • raw/2m_dewpoint_temperature_2020_01.nc" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;align=left" vertex="1" parent="1">
          <mxGeometry x="380" y="1020" width="320" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="edge7" edge="1" parent="1" source="output" target="cleanup">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Title -->
        <mxCell id="title" value="ECMWF VPD (Vapor Pressure Deficit) Data Flow" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="250" y="0" width="600" height="30" as="geometry"/>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
